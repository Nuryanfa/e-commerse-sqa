# ðŸ“‹ Review Lengkap: E-Commerce SQA Backend (Phase 1â€“6)

## 1. Ringkasan Proyek

| Item | Detail |
|------|--------|
| **Bahasa** | Golang (Go) |
| **Framework** | Gin Web Framework |
| **Database** | PostgreSQL + GORM (ORM) |
| **Arsitektur** | Clean Architecture (Domain â†’ Repository â†’ Usecase â†’ Delivery) |
| **Autentikasi** | JWT (HS256, 24 jam expiry) |
| **Hashing** | bcrypt (cost 14) |
| **Version Control** | Git â€” Feature Branch Workflow |

---

## 2. Arsitektur Clean Architecture

```mermaid
graph LR
    subgraph "HTTP Layer (Delivery)"
        H1[UserHandler]
        H2[CategoryHandler]
        H3[ProductHandler]
        H4[CartHandler]
        H5[OrderHandler]
    end
    subgraph "Business Logic (Usecase)"
        U1[UserUsecase]
        U2[CategoryUsecase]
        U3[ProductUsecase]
        U4[CartUsecase]
        U5[OrderUsecase]
    end
    subgraph "Data Access (Repository)"
        R1[UserRepository]
        R2[CategoryRepository]
        R3[ProductRepository]
        R4[CartRepository]
        R5[OrderRepository]
    end
    subgraph "Database"
        DB[(PostgreSQL)]
    end
    H1 --> U1 --> R1 --> DB
    H2 --> U2 --> R2 --> DB
    H3 --> U3 --> R3 --> DB
    H4 --> U4 --> R4 --> DB
    H5 --> U5 --> R5 --> DB
```

### Middleware Pipeline

```mermaid
graph LR
    A[Request] --> B[RecoveryMiddleware]
    B --> C[LoggerMiddleware]
    C --> D[CORS]
    D --> E{Route Type}
    E -->|Public| F[Handler]
    E -->|Auth| G[AuthMiddleware] --> F
    E -->|Admin| H[AuthMiddleware] --> I[RoleMiddleware] --> F
```

---

## 3. Struktur File

```
backend-go/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ api/main.go          # Entry point server
â”‚   â”œâ”€â”€ seed/main.go         # Database seeder (dummy data)
â”‚   â””â”€â”€ reset/main.go        # Database reset utility
â”œâ”€â”€ config/
â”‚   â””â”€â”€ database.go          # Konfigurasi PostgreSQL
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ domain/              # Struct & Interface (kontrak)
â”‚   â”‚   â”œâ”€â”€ user.go
â”‚   â”‚   â”œâ”€â”€ category.go
â”‚   â”‚   â”œâ”€â”€ product.go
â”‚   â”‚   â”œâ”€â”€ cart.go
â”‚   â”‚   â””â”€â”€ order.go
â”‚   â”œâ”€â”€ repository/          # Akses database (GORM)
â”‚   â”‚   â”œâ”€â”€ user_repository.go
â”‚   â”‚   â”œâ”€â”€ category_repository.go
â”‚   â”‚   â”œâ”€â”€ product_repository.go
â”‚   â”‚   â”œâ”€â”€ cart_repository.go
â”‚   â”‚   â””â”€â”€ order_repository.go
â”‚   â”œâ”€â”€ usecase/             # Logika bisnis
â”‚   â”‚   â”œâ”€â”€ user_usecase.go
â”‚   â”‚   â”œâ”€â”€ category_usecase.go
â”‚   â”‚   â”œâ”€â”€ product_usecase.go
â”‚   â”‚   â”œâ”€â”€ cart_usecase.go
â”‚   â”‚   â”œâ”€â”€ order_usecase.go
â”‚   â”‚   â”œâ”€â”€ user_usecase_test.go
â”‚   â”‚   â”œâ”€â”€ product_usecase_test.go
â”‚   â”‚   â”œâ”€â”€ cart_usecase_test.go
â”‚   â”‚   â””â”€â”€ order_usecase_test.go
â”‚   â”œâ”€â”€ delivery/http/       # HTTP Handler (endpoint)
â”‚   â”‚   â”œâ”€â”€ user_handler.go
â”‚   â”‚   â”œâ”€â”€ category_handler.go
â”‚   â”‚   â”œâ”€â”€ product_handler.go
â”‚   â”‚   â”œâ”€â”€ cart_handler.go
â”‚   â”‚   â””â”€â”€ order_handler.go
â”‚   â””â”€â”€ middleware/
â”‚       â”œâ”€â”€ auth_middleware.go
â”‚       â””â”€â”€ logger_middleware.go
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ jwt/jwt.go
â”‚   â”œâ”€â”€ password/password.go
â”‚   â””â”€â”€ response/response.go
â””â”€â”€ .env
```

---

## 4. Detail Per Phase

### Phase 1: Foundation & Authentication âœ…
- Setup project Go + Gin + GORM + PostgreSQL.
- User struct dengan validasi `binding` (min password 8 char, email format).
- Password di-hash dengan **bcrypt** â€” tidak pernah tersimpan plaintext.
- Login mengembalikan **JWT token** (24 jam expiry, HS256).
- Graceful Shutdown agar request yang sedang diproses tidak terputus saat server dimatikan.

### Phase 2: Product Catalog Management âœ…
- **Category** dan **Product** CRUD lengkap.
- Relasi `Product â†’ Category` (BelongsTo) dengan `Preload` otomatis.
- Validasi: Harga harus > 0 (`gt=0`), Stok harus â‰¥ 0 (`gte=0`).
- CategoryID divalidasi keberadaannya sebelum produk dibuat.

### Phase 3: Shopping Cart âœ…
- **Upsert Logic**: Jika produk yang sama ditambahkan, kuantitas ditambahkan (bukan duplikat).
- **Stock Check**: Validasi stok gabungan (yang sudah di keranjang + yang baru ditambahkan) terhadap stok gudang.
- **Ownership Protection**: User hanya bisa memanipulasi keranjang miliknya sendiri.

### Phase 4: Order & Checkout (ACID Transaction) âœ…
> [!IMPORTANT]
> Ini adalah fitur SQA paling krusial di seluruh backend.

- Checkout menggunakan **GORM `db.Transaction()`** untuk menjamin **ACID Compliance**:
  1. **Atomicity** â€” Semua langkah sukses atau semua di-rollback.
  2. **Consistency** â€” Stok tidak pernah negatif.
  3. **Isolation** â€” Data dibaca dalam konteks transaksi.
  4. **Durability** â€” Setelah commit, data persisten.

- **PriceAtPurchase** â€” Harga disnapshot saat checkout, sehingga perubahan harga produk di masa depan tidak mempengaruhi riwayat pesanan.

### Phase 5: Security Middleware âœ…
- **AuthMiddleware** â€” Validasi JWT dari header `Authorization: Bearer <token>`.
- **RoleMiddleware** â€” Memeriksa role user (hanya `admin` yang bisa CUD produk/kategori).
- Endpoint displit menjadi 3 tier akses:

| Tier | Endpoint | Proteksi |
|------|----------|----------|
| ðŸŒ Public | `GET /api/products`, `GET /api/categories`, Login, Register | Tidak ada |
| ðŸ”’ Auth | Cart, Checkout, Orders | JWT Token |
| ðŸ›¡ï¸ Admin | CUD Categories, CUD Products | JWT + Role "admin" |

### Phase 6: Testing & Error Handling âœ…
- **Centralized Response** â€” `pkg/response/response.go` dengan format JSON standar.
- **Logger Middleware** â€” Mencatat method, path, status, latency, dan IP.
- **Recovery Middleware** â€” Menangkap panic, mencegah server crash.
- **15 Unit Tests (White Box)** â€” Semua PASS.

---

## 5. Bug yang Ditemukan & Diperbaiki

Selama proses code review dan manual testing, kami menemukan **7 bug**:

| # | Severity | File | Bug | Fix |
|---|----------|------|-----|-----|
| 1 | ðŸ”´ Critical | `order_repository.go` | `string(rune(stock))` mengkonversi int ke Unicode char, bukan string angka | `fmt.Errorf("%d", stock)` |
| 2 | ðŸ”´ Critical | `domain/user.go` | `binding:"required,oneof=admin..."` memungkinkan **Privilege Escalation** â€” user bisa daftar sebagai admin | Hapus binding dari Role, set server-side |
| 3 | ðŸŸ¡ Medium | `cart_usecase.go` | Stock check hanya memeriksa quantity baru, mengabaikan unit yang sudah ada di keranjang | Validasi terhadap `existingInCart + newQty` |
| 4 | ðŸŸ¢ Low | `cart_handler.go` | Typo: "berhasi" â†’ "berhasil" | Perbaikan teks |
| 5 | ðŸ”´ Critical | Semua domain structs | Tag `db:""` tidak dibaca GORM â†’ kolom database salah nama | Ganti dengan `gorm:"column:xxx"` |
| 6 | ðŸ”´ Critical | `cart_repository.go` | Query `WHERE user_id` salah karena kolom bernama `id_user` | Sesuaikan nama kolom |
| 7 | ðŸŸ¡ Medium | `domain/cart.go` | `binding:"required"` pada UserID menyebabkan 400 padahal diisi dari JWT | Hapus binding dari UserID |

---

## 6. Hasil Unit Testing (White Box)

```
$ go test ./... -v
=== RUN   TestRegister_Success          â†’ PASS
=== RUN   TestRegister_DuplicateEmail   â†’ PASS
=== RUN   TestLogin_Success             â†’ PASS
=== RUN   TestLogin_WrongPassword       â†’ PASS
=== RUN   TestProductCreate_Success     â†’ PASS
=== RUN   TestProductCreate_InvalidCat  â†’ PASS
=== RUN   TestProductUpdate_Success     â†’ PASS
=== RUN   TestProductUpdate_NotFound    â†’ PASS
=== RUN   TestProductDelete_NotFound    â†’ PASS
=== RUN   TestAddToCart_Success         â†’ PASS
=== RUN   TestAddToCart_ProductNotFound â†’ PASS
=== RUN   TestAddToCart_ExceedsStock    â†’ PASS
=== RUN   TestUpdateQuantity_Success    â†’ PASS
=== RUN   TestUpdateQuantity_NotOwned   â†’ PASS
=== RUN   TestRemoveFromCart_Success    â†’ PASS
=== RUN   TestCheckout_Success          â†’ PASS
=== RUN   TestCheckout_EmptyCart        â†’ PASS

ok  github.com/nuryanfa/e-commerse-sqa/internal/usecase  PASS
```

> **17 test cases, 0 failures.**

---

## 7. Hasil Manual Testing (Black Box)

| Test | Endpoint | Expected | Actual |
|------|----------|----------|--------|
| Login pembeli | `POST /api/users/login` | 200 + JWT | âœ… 200 |
| Lihat produk | `GET /api/products` | 200 + data | âœ… 200 |
| Tambah ke cart | `POST /api/cart` | 200 | âœ… 200 |
| Checkout | `POST /api/orders/checkout` | 201 + order | âœ… 201 |
| Bayar | `POST /api/orders/:id/pay` | 200 PAID | âœ… 200 |
| RBAC â€” pembeli buat kategori | `POST /api/categories` | 403 Forbidden | âœ… 403 |

---

## 8. Git Branch History

```
main
 â”œâ”€â”€ chore/backend-structure     â†’ Setup awal project
 â”œâ”€â”€ feat: implement auth...     â†’ Phase 1 (Authentication)
 â”œâ”€â”€ feat: implement category... â†’ Phase 2 (Catalog)
 â”œâ”€â”€ feature/shopping-cart       â†’ Phase 3 & 4 (Cart + Checkout)
 â”œâ”€â”€ fix/code-review-bugs        â†’ Bug fixes dari code review
 â”œâ”€â”€ feature/security-middleware â†’ Phase 5 (RBAC)
 â”œâ”€â”€ feature/sqa-testing...      â†’ Phase 6 (Testing)
 â””â”€â”€ fix: GORM column mappings  â†’ Bug fixes dari manual testing
```

---

## 9. Fitur Keamanan (SQA Security Checklist)

| Fitur | Status | Detail |
|-------|--------|--------|
| Password Hashing | âœ… | bcrypt cost 14 |
| JWT Authentication | âœ… | HS256, 24h expiry |
| RBAC (Role-Based Access) | âœ… | Admin-only CUD endpoints |
| IDOR Prevention | âœ… | Cart/Order ownership check |
| Privilege Escalation Prevention | âœ… | Role diset server-side |
| SQL Injection Prevention | âœ… | GORM parameterized queries |
| CORS | âœ… | Restricted origins |
| Panic Recovery | âœ… | Server tidak crash |
| Graceful Shutdown | âœ… | Request aktif diselesaikan |
| ACID Transactions | âœ… | Checkout atomik |

---

## 10. Kesimpulan

Backend E-Commerce ini telah dibangun secara **bertahap dan terstruktur** selama 6 phase, mengikuti prinsip **Clean Architecture** dengan pemisahan yang jelas antara Domain, Repository, Usecase, dan Delivery layer. Setiap fitur dikembangkan dalam **feature branch** terpisah, di-review, dan di-merge ke main â€” sesuai best practice Version Control.

Dari sisi **SQA**, backend ini telah melalui:
- **White Box Testing** â€” 17 unit test dengan mock repository (100% pass)
- **Black Box Testing** â€” Manual API testing melalui Thunder Client
- **Code Review** â€” 7 bug ditemukan dan diperbaiki sebelum production
- **Security Audit** â€” 10 checklist keamanan terpenuhi

Backend ini siap untuk tahap selanjutnya: **integrasi dengan Frontend React** dan **pengujian oleh dosen penguji SQA**.
